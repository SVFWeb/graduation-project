# 数据库表关联说明

## 表关联关系分析

### 当前表结构关联关系

```
user (用户表)
  ↑
  ├── club_member.user_id (社团人员表)
  ├── activity.audit_user_id (活动表 - 审核人)
  └── activity_registration.user_id (活动报名表)
      └── activity_registration.audit_user_id (活动报名表 - 审核人)

club (社团表)
  ↑
  ├── club_member.club_id (社团人员表)
  └── activity.club_id (活动表)

activity (活动表)
  ↑
  └── activity_registration.activity_id (活动报名表)
```

## 是否需要外键约束？

### 方案一：不使用外键约束（当前方案）

**优点：**
1. ✅ **性能更好** - 插入/更新/删除操作不需要检查外键约束
2. ✅ **灵活性高** - 删除操作更简单，不需要考虑级联删除
3. ✅ **适合ORM框架** - MyBatis-Plus等ORM框架通常由应用层保证数据一致性
4. ✅ **适合分布式系统** - 在微服务架构中，外键约束可能不适合
5. ✅ **数据迁移方便** - 导入导出数据时不受外键限制

**缺点：**
1. ❌ 需要应用层保证数据完整性
2. ❌ 可能出现脏数据（如引用了不存在的ID）
3. ❌ 删除数据时需要手动处理关联数据

**适用场景：**
- 使用ORM框架（如MyBatis-Plus）
- 应用层有完善的数据校验逻辑
- 需要高性能的场景
- 分布式系统或微服务架构

### 方案二：使用外键约束（可选方案）

**优点：**
1. ✅ **数据完整性** - 数据库层面保证数据一致性
2. ✅ **防止脏数据** - 无法插入引用了不存在ID的数据
3. ✅ **级联操作** - 可以自动级联删除或更新
4. ✅ **文档化** - 表之间的关系更清晰

**缺点：**
1. ❌ **性能影响** - 每次操作都需要检查外键
2. ❌ **灵活性低** - 删除操作需要先删除子表数据
3. ❌ **维护复杂** - 外键约束可能影响数据迁移
4. ❌ **不适合分布式** - 在微服务中可能有问题

**适用场景：**
- 单体应用
- 对数据完整性要求极高的场景
- 数据库管理员需要明确表关系

## 推荐方案

**推荐使用方案一（不使用外键约束）**，原因：

1. **当前项目使用MyBatis-Plus** - ORM框架通常由应用层保证数据一致性
2. **已有完善的业务逻辑** - 代码中已经检查了关联数据是否存在
3. **性能考虑** - 外键约束会影响插入/更新/删除的性能
4. **灵活性** - 删除操作更简单，适合业务需求

## 当前设计说明

当前表结构已经通过以下方式保证数据完整性：

1. **唯一索引** - 防止重复数据
   - `club_member`: `uk_club_user` (club_id, user_id)
   - `activity_registration`: `uk_activity_user` (activity_id, user_id)

2. **普通索引** - 提升查询性能
   - 所有外键字段都有索引

3. **应用层校验** - 代码中检查关联数据是否存在
   - 加入社团时检查社团是否存在
   - 创建活动时检查社团是否存在
   - 报名活动时检查活动和用户是否存在

## 如果选择使用外键约束

如果决定使用外键约束，可以使用 `club_system_with_foreign_keys.sql` 文件，该文件包含：

- `club_member.club_id` → `club.id` (CASCADE)
- `club_member.user_id` → `user.id` (CASCADE)
- `activity.club_id` → `club.id` (CASCADE)
- `activity.audit_user_id` → `user.id` (SET NULL)
- `activity_registration.activity_id` → `activity.id` (CASCADE)
- `activity_registration.user_id` → `user.id` (CASCADE)
- `activity_registration.audit_user_id` → `user.id` (SET NULL)

**外键策略说明：**
- `ON DELETE CASCADE`: 删除主表记录时，自动删除子表相关记录
- `ON DELETE SET NULL`: 删除主表记录时，将子表外键设置为NULL（用于可选关联）
- `ON UPDATE CASCADE`: 更新主表主键时，自动更新子表外键

## 总结

**建议保持当前设计（不使用外键约束）**，因为：
1. 更适合ORM框架的使用场景
2. 性能更好
3. 灵活性更高
4. 已有应用层保证数据完整性

如果对数据完整性有极高要求，可以考虑使用外键约束版本。

